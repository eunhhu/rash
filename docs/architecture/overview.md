# 아키텍처 총괄

## 시스템 구조

```
┌─────────────────────────────────────────────────────────────┐
│                     Tauri Desktop App                        │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐   │
│  │              SolidJS Frontend (WebView)               │   │
│  │                                                       │   │
│  │  ┌─────────┐  ┌──────────┐  ┌──────────┐           │   │
│  │  │ Route   │  │ Schema   │  │ Handler  │           │   │
│  │  │ Explorer│  │ Editor   │  │ Editor   │           │   │
│  │  └────┬────┘  └────┬─────┘  └────┬─────┘           │   │
│  │       │             │             │                   │   │
│  │  ┌────┴─────────────┴─────────────┴──────┐           │   │
│  │  │          State Management              │           │   │
│  │  │    (SolidJS Store + IPC Bridge)        │           │   │
│  │  └───────────────┬───────────────────────┘           │   │
│  └──────────────────┼───────────────────────────────────┘   │
│                     │ Tauri IPC (invoke/events)              │
│  ┌──────────────────┼───────────────────────────────────┐   │
│  │              Rust Backend                             │   │
│  │                  │                                    │   │
│  │  ┌───────────────┴─────────────────┐                 │   │
│  │  │         Core Engine              │                 │   │
│  │  │                                  │                 │   │
│  │  │  ┌──────────┐  ┌─────────────┐  │                 │   │
│  │  │  │ Spec I/O │  │  Validator   │  │                 │   │
│  │  │  │ (R/W)    │  │  (Schema)    │  │                 │   │
│  │  │  └──────────┘  └─────────────┘  │                 │   │
│  │  │                                  │                 │   │
│  │  │  ┌──────────────────────────┐   │                 │   │
│  │  │  │     Code Generator       │   │                 │   │
│  │  │  │  ┌────────┐ ┌────────┐   │   │                 │   │
│  │  │  │  │Emitter │ │Adapter │   │   │                 │   │
│  │  │  │  │(Lang)  │ │(FW)    │   │   │                 │   │
│  │  │  │  └────────┘ └────────┘   │   │                 │   │
│  │  │  └──────────────────────────┘   │                 │   │
│  │  │                                  │                 │   │
│  │  │  ┌──────────────────────────┐   │                 │   │
│  │  │  │   Runtime Manager        │   │                 │   │
│  │  │  │  ┌────────┐ ┌────────┐   │   │                 │   │
│  │  │  │  │Process │ │  HMU   │   │   │                 │   │
│  │  │  │  │Manager │ │Engine  │   │   │                 │   │
│  │  │  │  └────────┘ └────────┘   │   │                 │   │
│  │  │  └──────────────────────────┘   │                 │   │
│  │  └─────────────────────────────────┘                 │   │
│  └──────────────────────────────────────────────────────┘   │
│                     │                                        │
│                     │ Child Process (spawn)                  │
│  ┌──────────────────┼───────────────────────────────────┐   │
│  │           Server Runtime                              │   │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐             │   │
│  │  │   Bun    │ │  Node    │ │  Python  │  ...        │   │
│  │  │ (Hono)   │ │(Express) │ │(FastAPI) │             │   │
│  │  └──────────┘ └──────────┘ └──────────┘             │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

## 데이터 흐름

### 1. 설계 흐름 (Design Flow)

사용자가 GUI에서 서버를 설계할 때의 데이터 흐름이다.

```
[GUI 조작]
    │
    ▼
[SolidJS Store 업데이트]
    │
    ▼
[IPC invoke: save_spec]
    │
    ▼
[Rust: Spec 검증 + 직렬화]
    │
    ▼
[파일 시스템에 JSON 저장]
    │
    ├── routes/api/v1/users.route.json
    ├── schemas/user.schema.json
    ├── models/user.model.json
    └── middleware/auth.middleware.json
```

### 2. 코드 생성 흐름 (Codegen Flow)

스펙에서 실행 가능한 코드를 생성하는 흐름이다.

```
[Spec JSON 파일들]
    │
    ▼
[Spec Parser → IR (Intermediate Representation)]
    │
    ▼
[LanguageEmitter 선택 (TS / Rust / Python / Go)]
    │
    ▼
[FrameworkAdapter 적용 (Express / Actix / FastAPI / ...)]
    │
    ▼
[실행 가능한 코드 파일 출력]
    │
    ├── dist/ts-express/
    │   ├── src/routes/users.ts
    │   ├── src/middleware/auth.ts
    │   └── package.json
    │
    └── dist/rust-actix/
        ├── src/routes/users.rs
        ├── src/middleware/auth.rs
        └── Cargo.toml
```

### 3. 실행 흐름 (Runtime Flow)

앱 내에서 서버를 실행하는 흐름이다.

```
[사용자: "Run" 버튼 클릭]
    │
    ▼
[Rust: 코드 생성 (또는 캐시 사용)]
    │
    ▼
[Rust: Child Process 생성]
    │  (bun run, node, python, cargo run)
    ▼
[서버 프로세스 실행 중]
    │
    ├── stdout/stderr → 프론트엔드 로그 패널
    ├── 포트 감지 → 프론트엔드 상태 표시
    └── HMU 채널 대기
```

### 4. HMU 흐름 (Hot Module Update)

코드 변경 시 실시간으로 서버를 갱신하는 흐름이다.

```
[GUI에서 핸들러 수정]
    │
    ▼
[변경 감지 (Spec diff)]
    │
    ▼
[영향받는 모듈만 재생성]
    │
    ▼
[HMU 프로토콜로 서버에 전송]
    │  (IPC/Unix Socket/HTTP)
    ▼
[서버 런타임: 모듈 교체]
    │
    ▼
[응답: 교체 완료 또는 실패]
```

## 주요 모듈 간 관계

```
┌────────────────────────────────────────────────────────┐
│                   rash-core (lib)                       │
│                                                         │
│  ┌──────────┐    ┌──────────┐    ┌──────────────┐     │
│  │rash-spec │───▶│rash-ir   │───▶│rash-codegen  │     │
│  │          │    │          │    │              │     │
│  │• Route   │    │• IR Node │    │• Emitter     │     │
│  │• Schema  │    │• IR Type │    │• Adapter     │     │
│  │• Model   │    │• IR Expr │    │• Resolver    │     │
│  │• MW      │    │          │    │              │     │
│  └──────────┘    └──────────┘    └──────────────┘     │
│       │                                │               │
│       │          ┌──────────┐          │               │
│       └─────────▶│rash-valid│◀─────────┘               │
│                  │          │                           │
│                  │• Schema  │                           │
│                  │  Check   │                           │
│                  │• Type    │                           │
│                  │  Check   │                           │
│                  └──────────┘                           │
│                                                         │
│  ┌──────────────┐    ┌──────────────┐                  │
│  │rash-runtime  │    │rash-openapi  │                  │
│  │              │    │              │                  │
│  │• Process Mgr │    │• Import      │                  │
│  │• HMU Engine  │    │• Export      │                  │
│  │• Log Stream  │    │• Sync        │                  │
│  └──────────────┘    └──────────────┘                  │
└────────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────────┐
│                 rash-app (Tauri bin)                    │
│                                                         │
│  ┌──────────────┐    ┌──────────────┐                  │
│  │ IPC Commands │───▶│ rash-core    │                  │
│  │              │    │ (위 라이브러리)│                  │
│  └──────────────┘    └──────────────┘                  │
│                                                         │
│  ┌──────────────┐                                      │
│  │ Tauri State  │ (프로젝트 상태, 런타임 상태)         │
│  └──────────────┘                                      │
└────────────────────────────────────────────────────────┘
```

### 크레이트 의존성 그래프

```
rash-app (bin)
├── rash-core
│   ├── rash-spec       # 스펙 파싱/직렬화
│   ├── rash-ir         # 중간 표현
│   ├── rash-codegen    # 코드 생성
│   │   ├── rash-spec
│   │   └── rash-ir
│   ├── rash-valid      # 검증
│   │   ├── rash-spec
│   │   └── rash-ir
│   ├── rash-runtime    # 런타임 관리
│   └── rash-openapi    # OpenAPI 변환
│       └── rash-spec
└── tauri (framework)
```

## 핵심 설계 원칙

1. **Spec이 Single Source of Truth**: 모든 것은 스펙 파일에서 파생된다. GUI 상태, 생성 코드, OpenAPI 문서 모두 스펙으로부터 결정론적으로 생성된다.

2. **양방향 변환**: `Spec ↔ Code` 변환은 가능한 한 무손실이어야 한다. 코드에서 스펙으로 역파싱 시 유실되는 정보는 어노테이션/주석으로 보존한다.

3. **점진적 코드 생성**: 전체 프로젝트를 재생성하지 않고, 변경된 스펙만 감지하여 해당 파일만 재생성한다.

4. **플러그인 확장성**: 새로운 언어(Emitter), 프레임워크(Adapter), 미들웨어를 플러그인으로 추가할 수 있어야 한다.

5. **타입 안전성**: Rust 타입 시스템을 최대한 활용하여 스펙 파싱, IR 변환, 코드 생성 과정에서의 타입 오류를 컴파일 타임에 잡는다.
